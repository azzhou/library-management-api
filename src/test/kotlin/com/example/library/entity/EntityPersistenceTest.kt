package com.example.library.entity

import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager

@DataJpaTest
class EntityPersistenceTest @Autowired constructor(
    val entityManager: TestEntityManager
) {
    lateinit var book: Book
    lateinit var bookCopies: MutableList<BookCopy>
    lateinit var authors: MutableList<Author>

    // set up entities and database
    // use @BeforeEach because TestEntityManager is not available for @BeforeAll
    @BeforeEach
    fun setup() {
        // create entities
        // Author and BookCopy have autogenerated id fields, so this step needs to be done before each test
        authors = mutableListOf(
            Author("Neil", "Gaiman"),
            Author("Terry", "Pratchett")
        )
        book = Book("978-0060853983", "Good Omens",
            "William Morrow", "English", authors = authors)
        bookCopies = mutableListOf(
            BookCopy(BookFormat.PAPERBACK, book),
            BookCopy(BookFormat.HARDCOVER, book),
            BookCopy(BookFormat.EBOOK, book)
        )
        book.bookCopies = bookCopies

        // persist entities and sync persistence context with database
        entityManager.persist(book)
        bookCopies.map { entityManager.persist(it) }
        entityManager.flush()
    }

    @Test
    fun `Book, BookCopy, and Author entities are found in database`() {
        authors.map {
            assertThat(entityManager.find(Author::class.java, it.id)).isEqualTo(it)
        }
        assertThat(entityManager.find(Book::class.java, book.isbn)).isEqualTo(book)
        bookCopies.map {
            assertThat(entityManager.find(BookCopy::class.java, it.barcode)).isEqualTo(it)
        }
    }

    @Test
    fun `when Book is persisted then any BookCopy associated is persisted`() {
        val mistborn = Book("978-0765377135", "Mistborn: The Final Empire",
            "Tor Books", "English")
        val mistbornCopy = BookCopy(BookFormat.PAPERBACK, mistborn)
        mistborn.bookCopies.add(mistbornCopy)
        entityManager.persistAndFlush(mistborn)
        assertThat(entityManager.find(BookCopy::class.java, mistbornCopy.barcode)).isEqualTo(mistbornCopy)
    }

    @Test
    fun `when Book is merged then any BookCopy associated is merged`() {
        val bookCopy = bookCopies[0]
        bookCopy.status = BookStatus.BORROWED
        val foundStatus = entityManager.find(BookCopy::class.java, bookCopy.barcode).status
        assertThat(foundStatus).isEqualTo(bookCopy.status)
    }

    @Test
    fun `when Book is removed then any BookCopy associated is removed`() {
        entityManager.remove(book)
        assertThat(entityManager.find(Book::class.java, book.isbn)).isEqualTo(null)

        bookCopies.map {
            assertThat(entityManager.find(BookCopy::class.java, it.barcode)).isEqualTo(null)
        }
    }

    @Test
    fun `when Book is removed then associated Authors are NOT removed`() {
        entityManager.remove(book)
        assertThat(entityManager.find(Book::class.java, book.isbn)).isEqualTo(null)

        authors.map {
            assertThat(entityManager.find(Author::class.java, it.id)).isEqualTo(it)
        }
    }

    @Test
    fun `when Author is removed then associated Books are NOT removed`() {
        entityManager.remove(authors[0])
        assertThat(entityManager.find(Author::class.java, authors[0].id)).isEqualTo(null)
        assertThat(entityManager.find(Book::class.java, book.isbn)).isEqualTo(book)
    }

}